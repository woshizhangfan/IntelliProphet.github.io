<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="http://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">


    <title>问财精灵</title>
    <script type="text/javascript" src="{% static '/js/echarts.min.js' %}"></script>
    <link href="../static/css/style1.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript" src="../static/js/jQuery.min.js"></script>


</head>
<body>

    <div class="sti">
        <a class="sti_list menu" ></a>
        <a class="sti_list option"  href="login.html" >主页</a>
        <a class="sti_list option"  href="index.html">自研数据库</a>
        <a class="sti_list option"  href="index.html" >问财精灵</a>
    </div>
    <div class="search bar1">
        <form action="/graph/" method="POST">
            <input type="text" name="node" id="d3" placeholder="请输入您要搜索的内容...">
            <button type="submit"></button>
        </form>
    </div>

    <div class="page-container">
        <div class="page-item">
            <div class="background num3">
                <div class="chatbox">
                    <div id="content">
                        <div class="info_box">

                             <div class="info_r">
                                    </div>
                             <div class="info_l">
                                <img src='../static/image/profile.png' class='pic_l' width="1000">
                                <span class='info'>股市有风险，入市需谨慎！</span>
                            </div>

                        </div>
                        <form class="chat" action="">
                            <img src='../static/image/profile.png' id='pic' width="1000">
                            <input type="text" placeholder='了解最新行情数据和市场动态？' id='inp'>
                            <input type="button" value='发送' id='send'>
                        </form>
                    </div>
                </div>
                <div id="container_search" class="chatfigure" >
                    {% if ctx %}
                    {% elif search_neo4j_data %}
                    {% endif %}
                </div>

            </div>
        </div>
    </div>
    <script>
    var container = document.querySelector('.page-container')
    // 获取浏览器视窗高度
    var viewHeight = document.documentElement.clientHeight
    // 获取滚动的页数
    var pageNum = document.querySelectorAll('.page-item').length
    // 初始化当前位置, 距离原始顶部距离
    var currentPosition = 0
    // 设置页面高度
    container.style.height = viewHeight + 'px'

    // 向下滚动页面
    function goDown () {
      if (currentPosition > - viewHeight * (pageNum - 1)) {
        currentPosition = currentPosition - viewHeight
        container.style.top = currentPosition + 'px'
      }
      //当前页码
        console.log(currentPosition/viewHeight);

    }

    // 向上滚动页面
    function goUp () {
      if (currentPosition < 0) {
        currentPosition = currentPosition + viewHeight
        container.style.top = currentPosition + 'px'
      }
    }
    </script>
    <script>
    // 节流函数
    function throttle (fn, delay) {
      let baseTime = 0
      return function () {
        const currentTime = Date.now()
        if (baseTime + delay < currentTime) {
          fn.apply(this, arguments)
          baseTime = currentTime
        }
      }
    }
    </script>
    <script>
    // 初始鼠标滚动
    var handlerWheel = throttle(scrollMove, 1000)
    // https://developer.mozilla.org/en-US/docs/Web/API/Element/mousewheel_event#The_detail_property
    // firefox的页面滚动事件其他浏览器不一样
    if (navigator.userAgent.toLowerCase().indexOf('firefox') === -1) {
      document.addEventListener('mousewheel', handlerWheel)
    } else {
      document.addEventListener('DOMMouseScroll', handlerWheel)
    }
    function scrollMove (e) {
      if (e.deltaY > 0) {
        goDown()
      } else {
        goUp()
      }
    }
    </script>
    <script>
    // 处理移动端滑动
    var touchStartY = 0
    document.addEventListener('touchstart', event => {
      touchStartY = event.touches[0].pageY
    })
    var handleTouchEnd = throttle(touchEnd, 500)
    document.addEventListener('touchend', handleTouchEnd)
    function touchEnd (e) {
      var touchEndY = e.changedTouches[0].pageY
      if (touchEndY - touchStartY < 0) { // 向上滑动, 页面向下滚动
        goDown()
      } else {
        goUp()
      }
    }
    </script>
    <script type="text/javascript">

        const background = document.querySelector(".background")
        document.addEventListener('scroll', () => {
            const scrollY = window.scrollY

            if (scrollY !== 0) {
                background.style.backgroundPosition = `calc(50% + ${scrollY}px) calc(50% + ${scrollY}px)`
            }else{
                background.style.backgroundPosition = ''
            }
        })

        function drawplt(data){

            var search_neo4j_data=data
            var data2=search_neo4j_data['data']
            var links2=search_neo4j_data['links']
            console.log(data2)
            console.log(links2)
            var myObj = { firstname : "Bill", lastname : "Gates" };
            console.log(myObj);
            var myChart2 = echarts.init(document.getElementById('container_search'));
            var categories2 = [{name: "对象"}];
            option2 = {
                // 图的标题
                title: {
                    text: ""
                },
                // 提示框的配置
                tooltip: {
                    formatter: function (x) {
                        return x.data.des;
                    }
                },
                // 工具箱
                toolbox: {
                    // 显示工具箱
                    show: true,
                    feature: {
                        mark: {
                            show: true
                        },
                        // 还原
                        restore: {
                            show: true
                        },
                        // 保存为图片
                        saveAsImage: {
                            show: true
                        }
                    }
                },
                legend: [{
                    // selectedMode: 'single',
                    data: categories2.map(function (a) {
                        return a.name;
                    })
                }],
                series: [{
                    type: 'graph', // 类型:关系图
                    layout: 'force', //图的布局，类型为力导图
                    symbolSize: 40, // 调整节点的大小
                    roam: true, // 是否开启鼠标缩放和平移漫游。默认不开启。如果只想要开启缩放或者平移,可以设置成 'scale' 或者 'move'。设置成 true 为都开启
                    edgeSymbol: ['circle', 'arrow'],
                    edgeSymbolSize: [2, 10],
                    edgeLabel: {
                        normal: {
                            textStyle: {
                                fontSize: 20
                            }
                        }
                    },
                    force: {
                        repulsion: 2500,
                        edgeLength: [10, 50]
                    },
                    draggable: true,
                    lineStyle: {
                        normal: {
                            width: 2,
                            color: '#4b565b',
                        }
                    },
                    edgeLabel: {
                        normal: {
                            show: true,
                            formatter: function (x) {
                                return x.data.name;
                            }
                        }
                    },
                    label: {
                        normal: {
                            show: true,
                            textStyle: {}
                        }
                    },

                    // 数据
                    data: data2,
                    links: links2,
                    categories: categories2,
                }]
            };
            myChart2.setOption(option2);

        }
        drawplt([{{ search_neo4j_data|safe }}][0])


var send =document.getElementById('send');
var pic =document.getElementById('pic');
var txt =document.getElementById('inp');
var info_box = document.getElementsByClassName('info_box')[0];

var onoff=true;
pic.onclick=function(){
	if(onoff){
		pic.src='../static/image/profile.png';
		onoff=false;
	}
	else{
		pic.src='../static/image/profile.png';
		onoff=true;
	}
};

$("#send").click(function () {

	if(txt.value===''){
		alert('请输入内容');
	}

	else{

		var nDiv = document.createElement('div');
		var spans = document.createElement('span');
		var imgs = document.createElement('img');
		var sTxt = document.createTextNode(txt.value);
		var info_box = document.getElementsByClassName('info_box')[0];


		spans.appendChild(sTxt);
		nDiv.appendChild(spans);
		nDiv.appendChild(imgs);
		// nDiv.style.display='block';
		info_box.insertBefore(nDiv,info_box.lastChild);
		spans.className='infor';
	    nDiv.className='info_r';
	    imgs.src='../static/image/profile.png';

        $.ajax({
            // 1.指定朝哪个后端发送ajax请求
            url:'/hello/', //不写就是朝当前地址提交【与form表单的action参数相同】
            // 2.请求方式
            type:'post',  // 不指定默认就是get，都是小写
            // 3.数据
            data:{'quest':$('#inp').val()},
            // 4.回调函数:当后端给你返回结果的时候会自动触发，args接受后端的返回结果
            success:function (args) {
                $('.infol:last').text(args);
            }
        });
        $.ajax({
            // 1.指定朝哪个后端发送ajax请求
            url:'/chat_graph/', //不写就是朝当前地址提交【与form表单的action参数相同】
            // 2.请求方式
            type:'post',  // 不指定默认就是get，都是小写
            // 3.数据
            data:{'quest':$('#inp').val()},
            // 4.回调函数:当后端给你返回结果的时候会自动触发，args接受后端的返回结果
            success:function (args) {
                drawplt(eval('(' + args + ')'));
                console.log(eval('(' + args + ')'));
            }
        });

		var nDiv = document.createElement('div');
		var spans = document.createElement('span');
		var imgs = document.createElement('img');
		var sTxt = document.createTextNode("正在回复...");



		var info_box = document.getElementsByClassName('info_box')[0];
		spans.appendChild(sTxt);
		nDiv.appendChild(spans);
		nDiv.appendChild(imgs);
		// nDiv.style.display='block';
		info_box.insertBefore(nDiv,info_box.lastChild);
	    spans.className='infol';
			nDiv.className='info_l';
			imgs.src='../static/image/profile.png';
/*
		if(onoff==true){
			spans.className='infor';
			nDiv.className='info_r';
			imgs.src='img/2.png';
		}
		if(onoff==false){
			spans.className='infol';
			nDiv.className='info_l';
			imgs.src='img/1.png';
		}
*/
	}
	txt.value='';
})


</script>

</body>
</html>